---
layout: post
title:  "2020-05-15-深入理解java虚拟机笔记（一）"
date:   2020-05-15 21:03:36 +0530
categories: Web
tags: [java, jvm]
description: Java程序员把控制内存的权力交给了Java虚拟机，一旦出现内存泄漏和溢出方面的问题，如果不了解虚拟机是怎样使用内存的，那排查错误、修正问题将会成为一项异常艰难的工作
---

对于Java程序员来说，在虚拟机自动内存管理机制的帮助下，不再需要为每一个new操作去写配对的delete/free代码，不容易出现内存泄漏和内存溢出问题。不过，也正是因为Java程序员把控制内存的权力交给了Java虚拟机，一旦出现内存泄漏和溢出方面的问题，如果不了解虚拟机是怎样使用内存的，那排查错误、修正问题将会成为一项异常艰难的工作。

### Java虚拟机的内存模型

Java虚拟机在运行时管理的内存以下几个数据区域：程序计数器，本地方法栈，虚拟机栈，方法区，堆。

1. 程序计数器：它可以看作是当前线程所执行的字节码的行号指示器。为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，各条线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存。

2. 虚拟机栈：每个线程在创建时都会创建一个虚拟机栈，其内部保存一个个的栈帧（Stack Frame）栈帧。每个方法被执行的时候，Java虚拟机都会同步创建一个栈帧，用于存储局部变量表、操作数栈、动态连接、方法出口等信息。

3. 本地方法栈：记录使用到的本地（Native）方法服务信息。

4. 堆：被所有线程共享的一块内存区域，几乎所有的对象实例以及数组都应当在堆上分配。堆也是垃圾收集器管理的内存区域，因此也被称为GC堆。在内存管理的分代收集理论看来，这部分区域又可以划分为新生代，老年代，永久代等等。

5. 方法区：存放类型信息、常量、静态变量、即时编译器编译后的代码缓存等数据。

方法区和永久代是不同的。HotSpot虚拟机设计团队选择把收集器的分代设计扩展至方法区，或者说使用永久代来实现方法区而已，这样使得HotSpot的垃圾收集器能够像管理Java堆一样管理这部分内存，省去专门为方法区编写内存管理代码的工作，到了JDK8，已经完全废弃了永久代的概念。

### Ref

- 《深入理解Java虚拟机 第3版》
